---
title: "MPB dynamics and spread"
author:
  - "Alex M. Chubaty"
  - "Barry J. Cooke"
  - "Eliot J. B. McIntire"
date: "December 1, 2017"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
bibliography:
  - bibliography.bib
  - ../mpb-maps/climate-projections.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = TRUE, eval = TRUE, message = FALSE,
                      warning = FALSE)
```

# Introduction

The goal of this model is to simulate the spread of mountain pine beetle outbreaks as a function of the growth and dispersal of beetle-killed trees, called "red tops".

## Module descriptions

```{r child = 'modules/canWind/canWind.Rmd'}
```

```{r child = 'modules/mpbClimateData/mpbClimateData.Rmd'}
```

```{r child = 'modules/mpbMassAttacksData/mpbMassAttacksData.Rmd'}
```

```{r child = 'modules/mpbPine/mpbPine.Rmd'}
```

```{r child = 'modules/mpbRedTopGrowth/mpbRedTopGrowth.Rmd'}
```

```{r child = 'modules/mpbRedTopSpread/mpbRedTopSpread.Rmd'}
```

```{r child = 'modules/mpbManagement/mpbManagement.Rmd'}
```

# Installation and setup

Install the most recent version of the `SpaDES` package from the development branch (packages version `2.0.0` or higher is required.)

```{r install-packages}
if (is.null(getOption("repos"))) {
  options(repos = c(CRAN = "https://cran.rstudio.com/"))
}

if (!require(data.table)) {
  install.packages("data.table")
}
if (!require(devtools)) {
  install.packages("devtools")
}
if (!require(igraph)) {
  install.packages("igraph")
}
if (!require(raster)) {
  install.packages("raster")
}
if (!require(amc) || packageVersion("amc") < "0.1.3") {
  devtools::install_github("achubaty/amc@development", dependencies = TRUE)
}
if (!require(SpaDES) || packageVersion("SpaDES") < "2.0.0") {
  devtools::install_github("PredictiveEcology/SpaDES@development", dependencies = TRUE)
}
```

Load required packages and set some default options for data loading etc.

```{r additional-setup}
setPaths(
  cachePath = "~/SpaDES/cache",
  modulePath = "~/GitHub/MPB/SpaDES/modules"
)
if (interactive()) dev.useRSGD(FALSE)
```

# Initialize and run the simulation

## Define study area

The study area is the provinces of Alberta (AB), British Columbia (BC), and Saskatchewan (SK); however, during development, a much smaller area may be used.

**NOTE:** major GIS operations such as reprojecting and cropping are cached, to speed up subsequent running of the model.

```{r define-study-area, eval=FALSE}
## load CRS for the boreal raster
load(file.path(getOption("spades.modulePath"), "mpbMassAttacksData", "data",
               "west.boreal.RData")) ## loads studyArea object (spdf)
crs.boreal <- CRS(proj4string(studyArea))
rm(studyArea)

## define (small) study area for development
## skip this step if you want to use the default area af BC, AB, SK
load("app/inputs/demoArea_618.rds") ## loads `demoArea`

times <- list(start = 2011, end = 2020)
params <- list(
  mpbClimateData = list(suitabilityIndex = "G"),    ## Can be "G", "S", "L", "R"
  mpbPine = list(lowMemory = TRUE), ## set to TRUE on laptop
  mpbRedTopGrowth = list(dataset = "Berryman1979_forced")
)
objects <- list(studyArea = demoArea)

## use EITHER mpbRandomLandscapes OR mpbPine/mpbClimateData (not all three)
modules <- list(
  #"mpbRandomLandscapes",
  "mpbPine", "mpbClimateData",
  "mpbMassAttacksData",
  "mpbRedTopGrowth",
  "mpbRedTopSpread",
  "mpbManagement"
)
```

## Run the model

```{r simulation, fig.keep="last", eval=FALSE}
MPB <- simInit(times = times, params = params, modules = modules, objects = objects)

## the first time you run this, esp. w/ large study area, it will be slow because
## of the GIS operations taking place. However, because these slow steps are cached,
## subsequent runs will be much faster (plotting will became slowest step).
MPB2 <- spades(Copy(MPB), debug = TRUE)
```

## Simulation diagrams

### Module diagram

```{r module-diagram, fig.keep="last", eval=FALSE}
clearPlot()
vcol <- sapply(names(V(depsGraph(MPB))), function(v) {
  if (v == "_INPUT_") {
    "orange"
  } else if (v %in% c("mpbRedTopGrowth", "mpbRedTopSpread", "mpbManagement")) {
    "pink"
  } else {
    "lightblue"
  }
})
moduleDiagram(MPB, vertex.color = vcol, vertex.size = 30)
```

### Object diagram

```{r object-diagram, fig.keep="last", eval=FALSE}
clearPlot()
objectDiagram(MPB)
```

### Event diagram

```{r event-diagram, fig.keep="last", eval=FALSE}
clearPlot()
eventDiagram(MPB2)
```

# References

<!-- automatically generated from the bibbligrapty files in the yaml header above -->
