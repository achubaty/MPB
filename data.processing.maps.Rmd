# MPB maps data processing

**Alex M. Chubaty**

Canadian Forest Service
Pacific Forestry Centre
506 Burnside Road W
Victoria, BC V8Z 1M5

Université Laval
Faculté de foresterie, de géographie et de géomatique
Département des sciences du bois et de la forêt

*email:* [Alexander.Chubaty@nrcan.gc.ca][1]
*phone:* +1.250.298.2347

[1]: <mailto:Alexander.Chubaty@nrcan.gc.ca>

------------------------------------------------------------------

## Overview of MPB map data

Descriptions of:

- data sources
- data collected
- etc.

```{r setup.workspace, echo=FALSE, message=FALSE}
### SETUP R WORKING ENVIROMENT
source("workspace.maps.R")

num.cpus = 4            # maximum cpus to use

read.in.raw.maps = FALSE
reproj.raw.maps = FALSE
rasterize.maps = FALSE

res.maps = 1000
ext.maps = extent(x=-1027658, xmax=320751.9, ymin=5108872, ymax=6163350)
# map extent obtained using `locator(2)` on 'west' map
```

## Importing map data

### MPB `SpatialPoints` data

```{r import.maps-points, echo=FALSE}
if (read.in.raw.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")
  
  ### Read in raw maps, and save them as individual files
  ### - this may take a while...grab a coffee or something
  sfInit(cpus=num.cpus, parallel=TRUE)
    sfLibrary(rgdal)
    sfLibrary(sp)
      
    ### AB points maps
    ab.pnts.files = dir(path=file.path(maps.dir, "MPB", "ab_mpb"), pattern="spot")
    ab.pnts.dir.shp = unique(sapply(strsplit(ab.pnts.files, "\\."), function(x) x[[1]]))
    ab.pnts = sfClusterApplyLB(ab.pnts.dir.shp, fun=getOGR, dir=file.path(maps.dir, "MPB", "ab_mpb"))
    names(ab.pnts) = substr(sapply(strsplit(ab.pnts.dir.shp,"_"), function(x) x[[3]]), 1, 4)
    
    ### BC points maps
    bc.pnts.files = dir(path=file.path(maps.dir, "MPB", "province_BC"), pattern="spot")
    bc.pnts.dir.shp = unique(sapply(strsplit(bc.pnts.files, "\\."), function(x) x[[1]]))
    omit = which(match(bc.pnts.dir.shp, "ibm_spot_data_northernpoints_removed", nomatch=0)==1)
    if(length(omit)>0) bc.pnts.dir.shp = bc.pnts.dir.shp[-omit]
    bc.pnts = sfClusterApplyLB(bc.pnts.dir.shp, fun=getOGR, dir=file.path(maps.dir, "MPB", "province_BC"))
    names(bc.pnts) = sapply(strsplit(bc.pnts.dir.shp,"_"), function(x) x[[3]])
  
    # save for later use
    saveObjects(c("ab.pnts", "bc.pnts"), rdata.path)
  
    # clean up workspace
    rm(ab.pnts, ab.pnts.dir.shp, ab.pnts.files, bc.pnts, bc.pnts.dir.shp, bc.pnts.files, omit)
  sfStop()
}
```

### MPB `SpatialPolygons` data

```{r import.maps-polygons, echo=FALSE}
if (read.in.raw.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")
  
  ### Read in raw maps, and save them as individual files
  ### - this may take a while...grab a coffee or something
  sfInit(cpus=num.cpus, parallel=TRUE)
    sfLibrary(rgdal)
    sfLibrary(sp)
    
    ### AB poly maps
    ab.poly.files = dir(path=file.path(maps.dir, "MPB", "ab_mpb"), pattern="poly")
    ab.poly.dir.shp = unique(sapply(strsplit(ab.poly.files, "\\."), function(x) x[[1]]))
    ab.poly = sfClusterApplyLB(ab.poly.dir.shp, fun=getOGR, dir=file.path(maps.dir, "MPB", "ab_mpb"))
    names(ab.poly) = substr(sapply(strsplit(ab.poly.dir.shp,"_"), function(x) x[[3]]), 1, 4)
    
    # save these new map objects for later use
    saveObjects("ab.poly", rdata.path)
  
    ### BC poly maps
    bc.poly.files = dir(path=file.path(maps.dir, "MPB", "province_BC"), pattern="poly")
    bc.poly.dir.shp = unique(sapply(strsplit(bc.poly.files, "\\."), function(x) x[[1]]))
    bc.poly = sfClusterApplyLB(bc.poly.dir.shp, fun=getOGR, dir=file.path(maps.dir, "MPB", "province_BC"))
    names(bc.poly) = sapply(strsplit(bc.poly.dir.shp,"_"), function(x) x[[3]])
    
    # save these new map objects for later use
    saveObjects("bc.poly", rdata.path)
    
    # clean up workspace
    rm(ab.poly, ab.poly.dir.shp, ab.poly.files)
    rm(bc.poly, bc.poly.dir.shp, bc.poly.files)
  sfStop()
  
  # manual garbage collection to free recently unallocated memory
  for (i in 1:10) gc()
}
```

### Canadian boreal forest maps

```{r import.maps-boreal, echo=FALSE}
if (read.in.raw.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")
  
  west.provs = c("Alberta", "British Columbia", "Saskatchewan")
  
  ### BOREAL FOREST
  boreal <- getOGR("NABoreal", file.path(maps.dir, "boreal"))
  crs.boreal = CRS(proj4string(boreal))
  
  ### PROVINCE BOUNDARIES
  load(file.path(maps.dir, "CAN_adm1.RData"))
  canada1 = gadm
  canada1.boreal = spTransform(canada1, crs.boreal)
  west.boreal = canada1.boreal[na.omit(match(west.provs, canada1.boreal$NAME_1)),]
  rm(gadm, canada1)
  
  ### PROVINCIAL COUNTIES
  load(file.path(maps.dir, "CAN_adm2.RData"))
  canada2 = gadm
  canada2.boreal = spTransform(canada2, crs.boreal)
  canada2.boreal.dt = data.table(data.frame(canada2.boreal))
  setkey(canada2.boreal.dt, "NAME_1")
  subset = match(canada2.boreal.dt[west.provs]$PID, canada2.boreal@data$PID)
  #
  # `subset` produces data.table warning re: mixed font encodings
  #
  west2.boreal = canada2.boreal[subset,]
  rm(gadm, canada2, canada2.boreal.dt, subset)
  
  ### SUBSET ONLY WESTERN CANADIAN BOREAL FOR PLOTTING
  boreal.can <- boreal[boreal$COUNTRY=="CANADA",]
  west.boreal.union <- unionSpatialPolygons(west.boreal, west.boreal$ID_0, threshold=10) # threshold value???
  #boreal.west <- gIntersection(west.boreal.union, boreal.can) # ERROR MESSAGE BELOW
  ##
  ##  Error in RGEOSBinTopoFunc(spgeom1, spgeom2, byid, id, drop_not_poly, "rgeos_intersection") : 
  ##    TopologyException: Input geom 0 is invalid: Too few points in geometry component at or
  ##    near point 199577.44732574001 5470112.4132905202 at 199577.44732574001 5470112.4132905202
  ##
  rm(west.boreal.union)
  
  ### Save these new map objects for later use
  objects2save = c("boreal", "boreal.can", "boreal.west",
                   "canada1.boreal", "canada2.boreal",
                   "west.boreal", "west2.boreal")
  saveObjects(objects2save, rdata.path)
  rm(list=objects2save)
  rm(objects2save)
}
```

Boreal forest map data uses the `crs.boreal` projection below. We reproject the Canadian administrative boundaries maps to use this projection:

```{r crs.boreal, echo=FALSE}
if(!exists("crs.boreal")) {
  loadObjects("boreal", rdata.path)
  crs.boreal = CRS(proj4string(boreal))
  print(crs.boreal)
  rm(boreal)
}
```

**The Canadian boreal forest:**

```{r plot.canada.boreal fig.height=4 fig.width=7}
loadObjects(c("boreal.can", "canada1.boreal"), rdata.path)
darkgreen <- col2rgb("darkgreen")/255
col.bor <- rgb(darkgreen[1], darkgreen[2], darkgreen[3], alpha=0.5)
rm(darkgreen)

plot(canada1.boreal)
plot(boreal.can, col=col.bor, add=TRUE)
rm(boreal.can)
```

**The western Canadian boreal forest:**

```{r plot.western.boreal fig.height=5, fig.width=6}
loadObjects(c("boreal.west", "west.boreal"), rdata.path)
darkgreen <- col2rgb("darkgreen")/255
col.bor <- rgb(darkgreen[1], darkgreen[2], darkgreen[3], alpha=0.5)
rm(darkgreen)

plot(west.boreal)
#plot(boreal.west, col=col.bor, add=TRUE)) ## doesn't work yet
rm(boreal.west, west.boreal)
```

## Reproject MPB maps to `crs.boreal`

### MPB `SpatialPoints` data

```{r reproject.maps-points echo=FALSE}
if (reproj.raw.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")
  
  if(!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal = CRS(proj4string(boreal))
    rm(boreal)
  }
  
  loadObjects(c("ab.pnts", "bc.pnts"), rdata.path)
  
  ### REPROJECT AB, BC SO THEY ARE BOTH IN THE `boreal` PROJECTION
  sfInit(cpus=num.cpus, parallel=TRUE)
    sfLibrary(rgdal)
    
    ab.pnts.boreal = sfClusterApplyLB(ab.pnts, spTransform, crs.boreal)
    bc.pnts.boreal = sfClusterApplyLB(bc.pnts, spTransform, crs.boreal)
  
    names(ab.pnts.boreal) = names(ab.pnts)
    names(bc.pnts.boreal) = names(bc.pnts)
  
    # save these new map objects for later use
    saveObjects(c("ab.pnts.boreal", "bc.pnts.boreal"), rdata.path)
  
    # clean up workspace
    rm(ab.pnts.boreal, bc.pnts.boreal)
  sfStop()

  ### MERGE AB AND BC POINTSs
  wh.ab = na.omit(pmatch(names(bc.pnts.boreal), names(ab.pnts.boreal)))
  wh.bc = na.omit(pmatch(substr(names(ab.pnts.boreal), 1, 4), names(bc.pnts.boreal)))
  
  sfInit(cpus=num.cpus, parallel=TRUE)
    sfLibrary(sp)
    sfExport("ab.pnts.boreal", "bc.pnts.boreal", "crs.boreal", "wh.ab", "wh.bc")  
    
    bcab.pnts.boreal = sfClusterApplyLB(1:length(wh.ab), function(x) {
      out = merge(bc.pnts.boreal[[wh.bc[x]]], ab.pnts.boreal[[wh.ab[x]]], all=TRUE)
      coordinates(out) <- ~ coords.x1 + coords.x2
      out$ntrees = ifelse(!is.na(out$NUM_TREES), out$NUM_TREES, ifelse(!is.na(out$num_trees),out$num_trees, NA))
      return(out)})
    bcab.pnts.boreal = sfClusterApplyLB(bcab.pnts.boreal, function(x) {proj4string(x) <- crs.boreal; return(x)})
    names(bcab.pnts.boreal) = substr(names(bc.pnts.boreal)[wh.bc], 2, 5)
    
    saveObjects("bcab.pnts.boreal", rdata.path)
    rm(ab.pnts.boreal, bc.pnts.boreal)
  sfStop()
  
  rm(ab.pnts, bc.pnts, wh.ab, wh.bc)
}
```

### MPB `SpatialPolygons` data

```{r reproject.maps-polygons echo=FALSE}
if (reproj.raw.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")

  if(!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal = CRS(proj4string(boreal))
    rm(boreal)
  }
  
  loadObjects(c("ab.poly", "bc.poly"), rdata.path)
  
  ### REPROJECT AB AND BC SO THEY ARE BOTH IN THE `boreal` PROJECTION
  sfInit(cpus=num.cpus, parallel=TRUE)
    sfLibrary(rgdal)
    ab.poly.boreal = sfClusterApplyLB(ab.poly, spTransform, crs.boreal)
    names(ab.poly.boreal) = names(ab.poly)
    saveObjects("ab.poly.boreal", rdata.path)
  
    bc.poly.boreal = sfClusterApplyLB(bc.poly, spTransform, crs.boreal)
    names(bc.poly.boreal) = names(bc.poly)
    saveObjects("bc.poly.boreal", rdata.path)
  
    rm(ab.poly.boreal, bc.poly.boreal)
  sfStop()
  
  rm(ab.poly, bc.poly)
  
  # manual garbage collection to free recently unallocated memory
  for (i in 1:10) gc()

  ### merging poly data can't be done at this point -- will merge rasters
}
```

## Rasterize MPB maps

### Canadian boreal forest maps

```{r rasterize.maps-boreal echo=FALSE}
if (rasterize.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")
  
  if(!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal = CRS(proj4string(boreal))
    rm(boreal)
  }

  loadObjects("west.boreal", rdata.path)
  
  west.empty.raster = raster(extent(west.boreal))
  res(west.empty.raster) <- res.maps
  west.boreal.raster = rasterize(west.boreal, west.empty.raster)
  
  saveObjects("west.boreal.raster", rdata.path)
  
  rm(west.boreal, west.boreal.raster, west.empty.raster)
}
```

### MPB `SpatialPoints` data

```{r rasterize.maps-points echo=FALSE}
if (rasterize.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")
  
  if(!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal = CRS(proj4string(boreal))
    rm(boreal)
  }
  
  loadObjects(c("ab.pnts.boreal", "bc.pnts.boreal", "west.boreal.raster"), rdata.path)
  
  rasterize.mpb = function(x) {
    rasterize(x=x, y=west.boreal.raster,
              field=if(any(colnames(x@data)=="NUM_TREES")) {
                x@data$NUM_TREES
                } else {
                  x@data$num_trees, fun="sum"}
              )
  }
  
  sfInit(cpus=num.cpus, parallel=TRUE)
    sfLibrary(raster)
    sfExport("west.boreal.raster")
    
    ab.pnts.boreal.raster.stack = stack(sfClusterApplyLB(ab.pnts.boreal, rasterize.mpb))
    names(ab.pnts.boreal.raster.stack) = names(ab.pnts.boreal)
    saveObjects("ab.pnts.boreal.raster.stack", rdata.path)
    rm(ab.pnts.boreal.raster.stack)
  
    bc.pnts.boreal.raster.stack = stack(sfClusterApplyLB(bc.pnts.boreal, rasterize.mpb))
    names(bc.pnts.boreal.raster.stack) = names(bc.pnts.boreal)
    saveObjects("bc.pnts.boreal.raster.stack", rdata.path)
    rm(bc.pnts.boreal.raster.stack)
    
    bcab.pnts.boreal.raster.stack = stack(sfClusterApplyLB(bcab.pnts.boreal, rasterize.mpb))
    names(bcab.pnts.boreal.raster.stack) = names(bcab.pnts.boreal)
    saveObjects("bcab.pnts.boreal.raster.stack", rdata.path)
    rm(bcab.pnts.boreal.raster.stack)
  sfStop()

  rm(ab.pnts.boreal, bc.pnts.boreal, west.boreal.raster)
}
```

### MPB `SpatialPolygons` data

```{r rasterize.maps-polygons echo=FALSE}
if (rasterize.maps) {
  if (!exists("WORKSPACE")) source("workspace.maps.R")
  
  if(!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal = CRS(proj4string(boreal))
    rm(boreal)
  }
  
  loadObjects(c("ab.poly.boreal", "bc.poly.boreal", "west.boreal.raster"), rdata.path)
  
  ### we arbitrarily picked 1000 trees per 1ha
  ###   This NEEDS to be revisited.
  change.res = function(x, y=west.boreal.raster, field=1000, fun="last", ...) {
    rasterize(x=x, y=y, field=field, fun=fun, ...)
  }
  
  sfInit(cpus=num.cpus, parallel=TRUE)
    sfLibrary(raster)
    sfExport("west.boreal.raster")
    
    ab.poly.boreal.raster.stack = stack(sfClusterApplyLB(ab.poly.boreal, change.res))
    names(ab.poly.boreal.raster.stack) = names(ab.poly.boreal)
    # several rasters have no values because they were in southern Alberta
    notNAs = which(sapply(1:nlayers(ab.poly.boreal.raster.stack),
                       function(x) unique(!is.na(which.min(ab.poly.boreal.raster.stack[[x]])))))
    ab.poly.boreal.raster = ab.poly.boreal.raster.stack[[notNAs]] # remove the NA layers
    names(ab.poly.boreal.raster.stack) = unlist(strsplit(names(ab.poly.boreal),"poly"))[notNAs]
    saveObjects("ab.poly.boreal.raster.stack", rdata.path)
      
    bc.poly.boreal.raster.stack = stack(sfClusterApplyLB(bc.poly.boreal, change.res))
    names(bc.poly.boreal.raster.stack) = names(bc.poly.boreal)
    saveObjects("bc.poly.boreal.raster.stack", rdata.path)
    
    rm(change.res, notNAs)
  sfStop()
  
  ### merge ab and bc polygons
  ab.poly.boreal.raster.unstack = unstack(ab.poly.boreal.raster.stack)
  bc.poly.boreal.raster.unstack = unstack(bc.poly.boreal.raster.stack)
  
  bcab.poly.boreal.raster.unstack = bc.poly.boreal.raster.unstack
  
  wh.ab = na.omit(match(names(bc.poly.boreal.raster.stack), names(ab.poly.boreal.raster.stack)))
  wh.bc = na.omit(match(names(ab.poly.boreal.raster.stack), names(bc.poly.boreal.raster.stack)))
  bcab.poly.boreal.raster.unstack[wh.bc] = lapply(1:length(wh.bc), function(x) {
    out = merge(bc.poly.boreal.raster.unstack[[wh.bc[x]]], ab.poly.boreal.raster.unstack[[wh.ab[x]]])
    return(out)})
  bcab.poly.boreal.raster.stack = stack(bcab.poly.boreal.raster.unstack)
  names(bcab.poly.boreal.raster.stack) = names(bc.poly.boreal.raster.stack)
  
  saveObjects("bcab.poly.boreal.raster.stack", rdata.path)
  
  objects2rm <- c("ab.poly.boreal", "bc.poly.boreal", 
                  "ab.poly.boreal.raster.stack", "ab.poly.boreal.raster.unstack",
                  "bc.poly.boreal.raster.stack", "bc.poly.boreal.raster.unstack",
                  "bcab.poly.boreal.raster.stack", "bcab.poly.boreal.raster.unstack", 
                  "west.boreal.raster", "wh.ab", "wh.bc")
  rm(list=objects2rm)
  rm(objects2rm)
  
  # manual garbage collection to free recently unallocated memory
  for (i in 1:10) gc()
}
```

## Combine all MPB maps

```{r combine.maps-all echo=FALSE}
if (rasterize.maps) {
  ### combine bcab points and poly rasters
  loadObjects(c("bcab.pnts.boreal.raster.stack", "bcab.poly.boreal.raster.stack"), rdata.path)
  
  wh.pnts = na.omit(match(names(bcab.poly.boreal.raster.stack), names(bcab.pnts.boreal.raster.stack)))
  wh.poly = na.omit(match(names(bcab.pnts.boreal.raster.stack), names(bcab.poly.boreal.raster.stack)))
  
  all = list()
  inner.count = 0
  for (i in 1:nlayers(bcab.poly.boreal.raster.stack)) {
    if (any(names(bcab.poly.boreal.raster.stack)[i] == names(bcab.pnts.boreal.raster.stack))) {
      inner.count = inner.count + 1
      if (any(is.finite(cellStats(bcab.poly.boreal.raster.stack[[i]], "range")))) {
        all[[i]] = merge(bcab.pnts.boreal.raster.stack[[wh.pnts[inner.count]]],
                         bcab.poly.boreal.raster.stack[[wh.poly[inner.count]]])
      } else {
        all[[i]] = bcab.pnts.boreal.raster.stack[[wh.pnts[inner.count]]]
      }
    } else {
      all[[i]] = bcab.poly.boreal.raster.stack[[i]]
    }
  }
  
  all = lapply(all, function(x) { x[is.na(x)] <- 0; return(x) })
  all = lapply(all, function(x) { x[x>0] <- log(x[x>0])+10; return(x) })
  names(all) = substr(names(bcab.poly.boreal.raster.stack), 2, 5)
  
  bcab.all.boreal.raster.brick = brick(all)
  bcab.all.boreal.raster.stack = stack(all)
  
  names(bcab.all.boreal.raster.brick) = substr(names(bcab.poly.boreal.raster.stack), 2, 5)
  names(bcab.all.boreal.raster.stack) = substr(names(bcab.poly.boreal.raster.stack), 2, 5)
  
  saveObjects(c("bcab.all.boreal.raster.brick", "bcab.all.boreal.raster.stack"), rdata.path)
  
  rm(all, bcab.all.boreal.raster.brick, bcab.all.boreal.raster.stack, wh.pnts, wh.poly)
}
```

